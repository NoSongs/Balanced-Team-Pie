<!DOCTYPE html>
<head>
	<meta charset="utf-8" />
	<!-- Set the viewport width to device width for mobile -->
	<meta name="viewport" content="width=device-width" />
	
	<title>Balanced Team Pie - LUXr</title>
  
	<!-- Included CSS Files -->
	<link rel="stylesheet" href="css/jockstrap.css">

	<!--[if lt IE 9]>
		<link rel="stylesheet" href="css/ie.css">
	<![endif]-->

	
	<!-- IE Fix for HTML5 Tags -->
	<!--[if lt IE 9]>
		<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js">
        </script>
    <script type="text/javascript" src="js/d3.js"></script>
    <script type="text/javascript" src="js/d3.layout.js"></script>

    <script type="text/javascript" src="js/underscore-min.js"></script>
    <script type="text/javascript" src="https://simple-note.appspot.com/script/simperium.js"></script>

    <style type="text/css">
    .team-select {
        cursor: pointer;
    }
    </style>
</head>
<body>
<div class="container">

    <!-- splash-page begin -->
    <div class="page" id="splash-page">
        <div class="row home">
            <div class="span9">
                <h1>Balanced Team Pie</h1>
                <p>Identify the most critical skills needed for your team and
                your product to be successful.</p>
                <p>Create a visualization that clearly shows what skills are
                present in the team, where there are overlaps and where there
                are gaps.</p>
                <p class="home-actions">
                    <a class="btn primary large go-create"
                        href="javascript: void(0);">Start A New Team Pie</a>
                    <span>or</span>
                    <a href="javascript: void(0);"
                        class="btn secondary large go-join">Join Your Team In Progress</a>
                </p>
            </div>
            <div class="span7 home-pie">
            </div>
        </div>
    </div>
    <!-- splash-page end -->


    <!-- start-page begin -->
	<div class="page" id="start-page">
		<div class="row info">
			<div class="span2">
				<h1>1</h1>
			</div>
			<div class="span13">
                <p>The first task is to choose a list of areas of competency
                that you need to make your product successful. Keep it at a
                fairly high-level, like Code Development, UX Design, Marketing
                or Accounting.</p>
			</div>
		</div>
		<div class="container-small cell">
			<div class="content">
				<div class="row">
					<div class="span4">
						<div class="clearfix">
                            <input id="company-name" class="span9"
                                placeholder="Company or Project Name" type="text"></input>
                        </div>
					</div>	
				</div>
				<br />
				<div class="row">
					<div class="span9-half">
						<h3>Choose Your Team's Project Type:</h3>
						<br />
						<div class="team-select tech">
							<h4>Tech Startup</h4>
						</div>
						<div class="team-select circus">
							<h4>Circus Act</h4>
						</div>
						<div class="team-select santa">
							<h4>Santa's Workshop</h4>
						</div>
					</div>
				</div>
				<br />
				<div class="row">
					<div class="span9">
                        <a href="javascript: void(0);"
                            class="btn large primary go-code">Next</a>
					</div>
				</div>
			</div>
		</div>
	</div>
    <!-- start-page end -->


    <!-- code-page begin -->
	<div class="page" id="code-page">
		<div class="row info">
			<div class="span2">
				<h1>2</h1>
			</div>
			<div class="span13">
                <p>Congratulations!  You've created a new Balanced Team Pie for
                    <span class="company-name">Foo</span></p>
			</div>
		</div>
		<div class="container-small cell">
			<div class="content">
				<div class="row">
					<div class="span9-half">
						<h3>Here's The Access Code For Your Team To Join In:</h3>
						<br />
						<h1 class="access-code-big">X 9 L o</h1>
						<br />
						<div class="begin">
							<a href="javascript: void(0);" class="btn large primary">Begin</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
    <!-- code page end -->


    <!-- join-page begin -->
	<div class="page" id="join-page">
		<div class="row info">
			<div class="span2">
				<h1>1</h1>
			</div>
			<div class="span13">
                <p>Welcome.</p>
			</div>
		</div>
		<div class="container-small cell">
			<div class="content">
				<div class="row">
					<div class="span9-half">
						<h3>Enter the access code to join</h3>
						<br />
                        <p class="join-page-error">
                        </p>
						<br />
                        <input type="text"></input>
						<br />
                        <a href="javascript: void(0);" class="btn large primary">Join</a>
					</div>
				</div>
			</div>
		</div>
	</div>
    <!-- join-page end -->


    <!-- vote page begin -->
    <script id="tpl-vote-page-option" type="text/x-jquery-tmpl">
        {{each options}}
        <div class="radio-inputs">
            <h5>${$value}</h5>
		<input type="radio" name="category-${$index}" value="0" /><span>0</span>
		<input type="radio" name="category-${$index}" value="1" /><span>1</span>
		<input type="radio" name="category-${$index}" value="2" /><span>2</span>
		<input type="radio" name="category-${$index}" value="3" /><span>3</span>
		<input type="radio" name="category-${$index}" value="4" /><span>4</span>
	</div>
        {{/each}}
    </script>
    <div class="page" id="vote-page">
	<div class="row info">
		<div class="span2">
			<h1>3</h1>
		</div>
		<div class="span13">
			<p>Vote using the following scale:
				<ul>
					<li>0 - No exposure</li>
					<li>1 - Some exposure and/or theoretical knowledge</li> 
					<li>2 - Have done this before</li> 
					<li>3 - Done this many times, feel confident</li> 
					<li>4 - Have a lot of expertise</li> 
				</ul>
			</p>
		</div>
	</div>
	<div class="container-small cell">
			<div class="content">
				<div class="row">
					<div class="span9-half">
						<input id="member-name" placeholder="Your Name" class="span9" type="text"></input>
							<br />
							<br/>
							<h3>How would you rate you ability in these areas?</h3>
							<div class="options"></div>
							<br/>
							<div class="results">
								<a href="javascript: void(0);" class="btn large primary">See Results</a>
							</div>
					</div>
				</div>
			</div>
	</div>
    </div>
    <!-- vote page end -->


    <!-- pie page begin -->
    <script id="tpl-pie-users" type="text/x-jquery-tmpl">
        {{each users}}
        <div>
            ${$value}
        </div>
        {{/each}}
    </script>
    <div class="page" id="pie-page">
        <a style="position:absolute; margin-left:0px; margin-top:0px"
            href="javascript: void(0);" class="btn primary go-vote">Change your scores</a>
        <div id="pie-users" style="position:absolute; margin-left:0px; margin-top:60px">
        </div>
        <div id="the-pie">
        </div>
    </div>
    <!-- pie page end -->

</div>

<script>
var bucket;
var users = {};
var code;
var state;

var options = [
    "Juggling",
    "Mini car driving",
    "Tightrope walking",
    "Lion taming",
    "Fire breathing",
    "Curiously deformed",
    "Knife throwing",
    "Knife target",
    ];

function make_code() {
    var text = "";
    var possible = "abcdefghijklmnopqrstuvwxyz0123456789";
    for(var i=0; i < 4; i++)
        text += possible.charAt(Math.floor(Math.random() * possible.length));
    return text;
}

function weight(category, level) {
    var ret = 0;
    _.each(_.values(users), function (x) {
        if(x['scores'][category] >= level) ret += .2;
    });
    return ret;
}

// SIMPERIUM
function start_simperium(code) {
    SIMPERIUM_OPTS = {
        host        : 'apiotra.simperium.com',
        port        : '80',
        token       : '991a75556cc14e4b8b556d8cb67feb55'
    };

    bucket = new Simperium('app-society-569', code, SIMPERIUM_OPTS);
    bucket.set_get_data(get_data);
    bucket.set_notify(notify);
    bucket.set_initialized(initialized);
    bucket.initialize_client();
    bucket.start();
}
function initialized(){
    if(state=="join") {
        if(bucket.data.p == "0") {
            $('.join-page-error').html('bad code');
            return;
        }
        $('.page').hide();
        $('#vote-page').show();
    }
}
function get_data(id) {return null;}
function notify(id, data) {
    console.log(id);
    console.log(data);
    if(id.substr(0,5) == 'user.') {
        users[id.substr(5)] = data;
        draw_pie(options);
    }
}
//

$(document).ready(function(){
    //
    // wire up splash-page
    $('.go-create').click(function(){
        $('.page').hide();
        $('#start-page').show();
    });
    $('.go-join').click(function(){
        state = "join";
        $('.page').hide();
        $('#join-page').show();
    });

    //
    // wire up create-page
    var team_select_background = $('.team-select').css('background-color');
    var company_name, team_type;
    function show_next() {
        $('.next').show();
    }
    $('.team-select').click(function(){
        $('.team-select').css('background-color', team_select_background);
        $(this).css('background-color', 'yellow');
        show_next();
    });
    $('.go-code').click(function(){
        var code = make_code();
        $('.access-code-big').html(code);

        start_simperium(code);

        bucket.update('company', {'name': $('#company-name').val()});
        $('.company-name').html($('#company-name').val());

        $('.page').hide();
        $('#code-page').show();
    });

    //
    // wire up join-page
    $('#join-page a').click(function(){
        var code = $('#join-page input').val();
        start_simperium(code);
    });

    $( "#tpl-vote-page-option" ).tmpl({options:options}).appendTo(".options");

    $('.begin a').click(function(){
        $('.page').hide();
        $('#vote-page').show();
        $( "#tpl-vote-page-option" ).tmpl({options:options}).appendTo(".options");
    });

    $('.results a').click(function(){
        var choices = [];
        for(var i=0; i<=7; i++) {
            choices[choices.length] = $('input[name=category-'+i+']:checked').val();
        }
        var member_name = $('#member-name').val();
        bucket.update('user.'+member_name, {scores: choices});

        users[member_name] = {scores: choices};
        draw_pie(options);

        $('.page').hide();
        $('#pie-page').show();
    });

    $('.go-vote').click(function(){
        $('.page').hide();
        $('#vote-page').show();
    });


    function draw_pie(options) {
        $("#pie-users").html('');
        $( "#tpl-pie-users" ).tmpl({users:_.keys(users)}).appendTo("#pie-users");

        var slice_spacing = .00;
        var w = 450,
            h = 450,
            r = Math.min(w, h) / 2,
            color = d3.scale.category20(),
            donut = d3.layout.pie(),
            arc = d3.svg.arc().innerRadius(r * .90).outerRadius(r);

        $("#the-pie").html('');
        var vis = d3.select("#the-pie")
          .append("svg:svg")
            .data([options])
            .attr("width", 800)
            .attr("height", 600);

        var arcs = vis.selectAll("g.arc")
            .data(donut)
          .enter().append("svg:g")
            .attr("class", "arc")
            .attr("transform", function(d,i) {
                var xoffset = r+200;
                var yoffset = r+20;
                xoffset += 5 * Math.sin((i+.5)*((Math.PI*2)/8));
                yoffset += -5 * Math.cos((i+.5)*((Math.PI*2)/8));
                return "translate(" + xoffset + "," + yoffset + ")";
            });

        var category_colors = [
            "#000",
            "#73a",
            "#345",
            "#83b",
            "#222",
            "#00F",
            "#A22",
            "#0F0",
        ];
        arcs.append("svg:path")
            .attr("fill", function(d, i) { return category_colors[i]; })
            .attr("id", function(d, i) { return "slice-" + i })
            .attr("d", function(d, i) {
                var a = ((Math.PI*2)/8);
                return arc
                    .startAngle((i*a)+slice_spacing)
                    .endAngle(((i+1)*a) -slice_spacing)
                    ();
                });
        arcs.append("svg:text")
            .attr("fill", "#FFF")
            .attr("dy", "1.0em")
            .attr("text-anchor", "middle")
                .append("svg:textPath")
                    .attr("xlink:href", function(d,i) { return "#slice-" + i; })
                    .attr("startOffset", "22%")
                    .text(function(d, i) { return options[i]; });

        for(var level=4; level>0; level--) {
            var offset = -.2 + (level*.2)
            var depth = .18 + offset;
            if(level==4) depth += .1;
            arcs.append("svg:path")
                .attr("fill", function(d, i) { return '#000'; })
                .attr("fill-opacity", function(d, i) {
                    return weight(i, level);
                })
                .attr("d", function(d, i) {
                    var a = ((Math.PI*2)/8);
                    return d3.svg.arc()
                        .innerRadius(r * offset)
                        .outerRadius(r * depth)
                        .startAngle((i*a)+slice_spacing)
                        .endAngle(((i+1)*a) -slice_spacing)
                        ();
                });
        }
    } // end draw pie
});
</script>

</body>
</html>
